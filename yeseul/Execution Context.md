# 실행 컨텍스트(Execution Context)

: 실행할 코드에 제공할 환경 정보들을 모아놓은 객체

## 소스코드의 평가와 실행

: 자바스크립트 엔진은 모든 소스 코드를 평가 과정과 실행 과정을 통해 관리한다.

- 평가 과정 : 자바스크립트 엔진이 평가 과정에서 실행 컨텍스트를 생성하고 변수나 함수 등의 선언문만 실행해서 생성된 식별자를 실행 컨텍스트가 관리하는 스코프(렉시컬 환경의 환경 레코드)에 등록합니다. 

- 실행 과정 : 평가 과정이 끝나면 소스코드를 순차적으로 실행해서 결과를 도출합니다. 

```
var x;
x = 1;
```

위의 코드를 실행 과정과 평가 과정으로 나누어 설명해 보면,

평가 과정 : 변수 선언문 var x;를 먼저 실행해서 생성된 식별자인 x를 실행 컨텍스트가 관리하는 스코프에 등록하고 자바스크립트 엔진에 의해 임의적으로 undefined로 초기화됩니다

실행 과정 : 평가 과정이 끝나고 x = 1;이라는 변수 할당문을 실행해서 x라는 변수에 1이라는 값을 할당할 때 x라는 변수가 선언된 변수인지 아닌지 확인을 하게 되는데 이를 실행 컨텍스트가 관리하는 스코프를 검색해서 취득하게 됩니다. 이러한 참조를 통해 확인한 변수가 선언된 변수라면 할당 결과를 실행 컨텍스트에 등록하여 관리하고. 선언된 변수가 아니라면 ReferencError가 출력됩니다.

## 실행 컨텍스트 스택(Execution Context Stack)

: 실행 컨텍스트는 스택 자료구조로 가장 나중에 들어온 실행 컨텍스트가 가장 먼저 pop 됩니다. 이러한 실행 컨텍스트의 스택을 통해서 실행 순서를 관리하고 실행 순서를 보장합니다.

아래 코드의 실행 컨텍스트 스택 자료구조를 설명하면

```
const x = 1;
function foo () {
  const y = 2;
  
  function bar () {
  const z = 3;
  console.log(x + y + z);
  }
  bar();
}
foo(); // 6

```

1. 먼저 평가 과정에서 전역 변수 x와 전역 함수 foo를 수집하여 전역 실행 컨텍스트 생성하고 실행 컨텍스트 스택에 push 하면, 실행 과정을 통해 전역 변수 x에 값이 할당되고 전역 함수 foo가 호출됩니다.

2. 전역 함수 foo가 호출되면 코드의 제어권이 foo 함수 내부로 이동(블로킹!)해서 전역 코드의 실행은 일시 중단되고, foo 함수 내부의 함수 코드를 평가 과정을 통해 지역 변수 y와 지역 함수 bar를 수집하여 foo 함수 실행 컨텍스트를 생성하고 실행 컨텍스트 스택에 push 하면, 실행 과정을 통해 지역 변수 y에 값이 할당되고 중첩 함수 bar가 호출됩니다.

3. 중첩 함수 bar가 호출되면 코드의 제어권이 bar 함수 내부로 이동해서 foo 함수 코드의 실행은 일시 중단되고, bar 함수 내부의 함수 코드를 평가 과정을 통해 지역 변수 z를 수집하여 bar 함수 실행 컨텍스트를 생성하고 실행 컨텍스트 스택에 push 하면, 실행 과정을 통해 지역 변수 z에 값이 할당되고 console.log 메서드를 호출한 후 bar 함수는 종료된다.

4. bar 함수가 종료되면 코드의 제어권은 다시 foo 함수로 이동하고 bar 함수 실행 컨텍스트는 실행 컨텍스트 스택에서 pop 된다. 그리고 foo 함수는 더 이상 실행할 코드가 없으므로 종료된다. 

5. foo 함수가 종료되면 코드의 제어권은 다시 전역 코드로 이동하고 foo 함수 실행 컨텍스트는 실행 컨텍스트 스택에서 pop 된다. 그리고 더 이상 실행할 전역 코드가 남아있지 않으므로 종료된다.

6. 마지막으로 전역 실행 컨텍스트도 실행 컨텍스트 스택에서 pop되어 실행 컨텍스트 스택은 비워진다! 

## 실행 컨텍스트 내부

1. Variable Environment

: 현재 컨텍스트 내부의 식별자 정보를 담는 Environment Record와  자신의 외부 환경에 대한 참조를 가지는 Outer Lexical Environment Reference를 포함한다.

2. Lexical Environment

: 초기에는 Variable Environment와 같지만 변경사항이 실시간으로 반영되어 초기 상태를 기억하고 최신 상태를 저장한다.

3. THis Binding

: this 키워드가 바인딩되는 객체로 호출 방식에 따라 결정되고 전역 환경 레코드와 함수 환경 레코드에만 존재합니다.

## 전역 환경 레코드와 함수 환경 레코드에서의 var/ let, const

1. 전역 환경 레코드

- var로 선언한 전역 변수는 객체 환경 레코드에 저장

- let, const로 선언한 전역 변수는 선언적 환경 레코드에 저장

2. 전역 환경 레코드와 달리 함수 환경 레코드는 분리되지 않고, 한 장소에서 var, let, const 모두를 처리!!

​# 실행 컨텍스트와 블록 레벨 스코프

- var 키워드로 선언한 변수는 오로지 함수의 코드 블록만 지역 스코프로 인정하는 함수 레벨 스코프

- let, const는 모든 코드 블록(함수, if 문, for 문, while 문, try/catch 문 등)을 지역 스코프로 인정하는 블록 레벨 스코프

출처

모던 자바스크립트 Deep Dive

https://youtu.be/QkCNba92Vqo? si=4ChOKK6IeExSuTUW